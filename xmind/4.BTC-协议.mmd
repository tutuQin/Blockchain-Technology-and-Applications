flowchart LR
    A["如何设计一个加密货币系统"] --> B["一、发行：谁有权“印钱”？"]
    A --> C["二、安全：如何防双花与造假？"]
    A --> D["三、共识：全网如何达成一致？"]
    A --> E["四、分布式系统：网络怎么组织？"]
    A --> G["五、比特币协议（完整运行规则）"]

    %% 一、发行：谁有权“印钱”？
    B --> B1["概念：发行权 = 谁能造新币"]
    B --> B2["传统：央行集中发行（法币）"]
    B --> B3["加密货币：协议决定发行权"]
    B3 --> B4["比特币：矿工通过挖矿获得新币（coinbase）"]
    B3 --> B5["货币政策写死在代码里（总量 2100 万）"]

    %% 二、安全：防双花与交易合法性
    C --> C1["问题：同一笔钱不能花两次（Double Spending）"]
    C --> C2["工具一：UTXO 模型"]
    C2 --> C21["每个输出只能被花一次"]
    C2 --> C22["节点检查：UTXO 是否存在且未花费"]
    C --> C3["工具二：交易验证逻辑"]
    C3 --> C31["签名验证：谁的币谁的私钥才能花"]
    C3 --> C32["金额检查：输入 ≥ 输出，差额为手续费"]
    C3 --> C33["Script 脚本：锁定/解锁规则是否成功"]
    C --> C4["工具三：PoW + 最长链规则"]
    C4 --> C41["想双花必须重写历史并超过全网算力"]
    C4 --> C42["成本极高 → 经济不可行"]

    %% 三、共识：全网怎么看法一致？
    D --> D1["定义：分布式共识（Distributed Consensus）"]
    D1 --> D11["没有中心服务器，全网仍能统一账本"]
    D --> D2["中本聪共识：PoW + 最长链"]
    D2 --> D21["挖矿 = 投入算力证明诚实性"]
    D2 --> D22["累计工作量最大的链 = 正史"]
    D --> D3["Sybil Attack（女巫攻击）与防御"]
    D3 --> D31["攻击：大量伪造身份控制网络"]
    D3 --> D32["比特币：用算力投票（PoW 防 Sybil）"]
    D3 --> D33["开再多节点，算力不变 → 影响有限"]

    %% 四、分布式系统视角
    E --> E1["分布式哈希表（DHT）"]
    E1 --> E11["用哈希定位数据，适合去中心化存储"]
    E1 --> E12["常用于 P2P、存储链、IPFS/Filecoin"]
    E --> E2["CAP 定理：一致性 / 可用性 / 分区容忍"]
    E2 --> E21["三者不可兼得"]
    E2 --> E22["区块链选择 AP（可用性+分区容忍）"]
    E2 --> E23["最终一致性：链同步有延迟"]
    E --> E3["传统共识：Paxos / Raft"]
    E3 --> E31["适用于少量、已知、可信节点"]
    E3 --> E32["不适合匿名、开放、公链环境"]
    E --> E4["Membership：节点成员管理"]
    E4 --> E41["传统：要身份管理"]
    E4 --> E42["比特币：Permissionless（人人可加入）"]

    %% 五、比特币完整协议规则
    G --> G1["节点规则：不同节点的角色与职责"]
    
    G1 --> G11["全节点 Full Node"]
    G11 --> G111["保存完整区块链"]
    G11 --> G112["验证所有区块和交易（全规则）"]
    G11 --> G113["拒绝不合法的区块和交易"]
    
    G1 --> G12["轻节点 SPV（Simplified Payment Verification）"]
    G12 --> G121["只保存区块头"]
    G12 --> G122["使用 Merkle Proof 验证交易被区块包含"]

    G1 --> G13["矿工节点 Miner"]
    G13 --> G131["在全节点基础上执行出块工作"]
    G13 --> G132["参与 PoW 挖矿"]
    G13 --> G133["生成 coinbase 交易"]

    %% 交易规则
    G --> G2["交易规则：合法交易的判定逻辑"]
    G2 --> G21["输入引用现有未花费输出（UTXO）"]
    G2 --> G22["签名必须正确（验证公钥）"]
    G2 --> G23["输入金额 ≥ 输出金额"]
    G2 --> G24["脚本 Script 执行为真"]
    G2 --> G25["双花检查：UTXO 是否已被花"]
    G2 --> G26["手续费规则写在协议中"]

    %% 区块规则
    G --> G3["区块规则：区块必须满足的条件"]
    G3 --> G31["区块头格式正确（版本、前哈希、Merkle root 等）"]
    G3 --> G32["区块内所有交易都逐笔验证"]
    G3 --> G33["区块大小不能超上限"]
    G3 --> G34["首笔交易必须是 coinbase"]
    G3 --> G35["coinbase 奖励 ≤ 当前补贴 + 手续费"]
    G3 --> G36["区块哈希必须满足难度目标（PoW）"]

    %% 共识规则（BTC协议中）
    G --> G4["共识规则：哪条链才是“真的”？"]
    G4 --> G41["采用累计工作量最大链"]
    G4 --> G42["即使短期分叉，最终会收敛一条主链"]
    G4 --> G43["无效区块不会被扩散，会被丢弃"]
    G4 --> G44["孤块或侧链最终被抛弃"]

    %% 网络传播规则
    G --> G5["网络传播：节点如何交流信息"]
    G5 --> G51["P2P 网络，去中心化连接结构"]
    G5 --> G52["交易和区块通过广播传播"]
    G5 --> G53["先广播哈希，再按需请求正文（节省流量）"]
    G5 --> G54["节点只信任自己能验证的数据"]
    G5 --> G55["防垃圾机制：拒绝无效交易/区块、不转发"]
    
    %% 综合
    A --> F["综合视角：这些模块如何拼成“一个币”？"]
    F --> F1["发行：coinbase + 货币规则 → 决定新币产生方式"]
    F --> F2["安全：UTXO + 签名 + Script → 确保交易无法造假"]
    F --> F3["共识：PoW + 最长链 → 全网同步“唯一账本”"]
    F --> F4["网络：P2P + 开放节点 → 不需要中心即可运作"]
    F --> F5["协议：节点规则 + 区块规则 → 网络能长期安全运行"]
