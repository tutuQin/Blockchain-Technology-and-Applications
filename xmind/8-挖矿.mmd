graph LR
    A["BTC 挖矿（第 08 讲）"]

    A --> B["全节点职责"]
    B --> B1["一直在线，参与 P2P 网络，收发区块和交易"]
    B --> B2["本地保存完整区块链数据"]
    B --> B3["维护内存中的 UTXO 集合，用于防双花"]
    B --> B4["验证交易与区块是否合法，丢弃非法数据"]
    B --> B5["选择并打包交易，维护本地交易池 mempool"]
    B --> B6["遵循'最长合法链'规则，处理分叉"]

    A --> C["矿工 = 带挖矿功能的全节点"]
    C --> C1["在全节点基础上额外执行 PoW"]
    C --> C2["决定沿哪条链挖：缺省为最长合法链"]
    C --> C3["从 mempool 中挑选交易构造新区块"]
    C --> C4["通过 coinbase 交易领取区块奖励+手续费"]

    A --> D["挖矿具体流程"]
    D --> D1["接收交易并验证，加入本地 mempool"]
    D --> D2["挑选交易 + 添加 coinbase 组成区块体"]
    D --> D3["设置前块哈希、Merkle 根、时间戳、难度，构造区块头"]
    D --> D4["不断改变 nonce 计算哈希，直到满足难度目标 H(header) ≤ target"]
    D --> D5["找到合法哈希后广播新区块"]
    D --> D6["其他节点验证新区块并接到各自最长链上"]

    A --> E["分叉与选链策略"]
    E --> E1["网络延迟导致同时出现多个同高区块，形成分叉"]
    E --> E2["矿工总是沿当前看到的最长合法链继续挖"]
    E --> E3["等长分叉时，缺省选择最先听到的那个分支"]
    E --> E4["一条分支先挖出下一个块后变更长，成为主链"]
    E --> E5["较短分支变为孤块链，奖励作废，交易需重新打包"]

    A --> F["难度、激励与安全性（与前一讲衔接）"]
    F --> F1["PoW 目标：控制平均出块时间约 10 分钟，通过难度定期调整"]
    F --> F2["矿工收益来源：区块奖励 + 手续费"]
    F --> F3["高算力 + 诚实遵守规则才能稳定获得收益"]
    F --> F4["大部分算力诚实时，最长链规则保证系统安全和最终一致性"]